<?php
require_once 'config.php';
requireLogin();

$doctor_id = $_SESSION['user_id'];
$success = $error = '';
$is_template = isset($_GET['template']) && $_GET['template'] == '1';
$from_template = isset($_GET['from_template']) ? (int)$_GET['from_template'] : 0;

date_default_timezone_set('Asia/Dhaka');

// Initialize form data
$form_data = [
    'bp' => '',
    'pulse' => '',
    'temperature' => '',
    'spo2' => '',
    'chief_complaints' => '',
    'medical_history' => '',
    'examination_findings' => '',
    'diagnosis' => '',
    'investigation' => '',
    'advice' => '',
    'next_visit' => '',
    'drugs' => []
];

// Load from template if specified
if ($from_template) {
    $sql = "SELECT * FROM prescriptions WHERE id = ? AND is_template = 1 AND doctor_id = ?";
    if ($stmt = mysqli_prepare($conn, $sql)) {
        mysqli_stmt_bind_param($stmt, "ii", $from_template, $doctor_id);
        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);
        $template_data = mysqli_fetch_assoc($result);

        if ($template_data) {
            $form_data = [
                'bp' => $template_data['bp'] ?? '',
                'pulse' => $template_data['pulse'] ?? '',
                'temperature' => $template_data['temperature'] ?? '',
                'spo2' => $template_data['spo2'] ?? '',
                'chief_complaints' => $template_data['chief_complaints'] ?? '',
                'medical_history' => $template_data['medical_history'] ?? '',
                'examination_findings' => $template_data['examination_findings'] ?? '',
                'diagnosis' => $template_data['diagnosis'] ?? '',
                'investigation' => $template_data['investigation'] ?? '',
                'advice' => $template_data['advice'] ?? '',
                'next_visit' => $template_data['next_visit'] ?? '',
                'drugs' => []
            ];

            // Load drugs
            $drug_sql = "SELECT pd.*, d.brand_name, d.generic_name, d.strength, d.manufacturer 
                         FROM prescription_drugs pd 
                         LEFT JOIN drugs d ON pd.drug_id = d.id 
                         WHERE pd.prescription_id = ?";
            if ($drug_stmt = mysqli_prepare($conn, $drug_sql)) {
                mysqli_stmt_bind_param($drug_stmt, "i", $from_template);
                mysqli_stmt_execute($drug_stmt);
                $drug_result = mysqli_stmt_get_result($drug_stmt);
                while ($d = mysqli_fetch_assoc($drug_result)) {
                    $form_data['drugs'][] = $d;
                }
            }
        }
    }
}

// Load templates for dropdowns
$template_types = [
    'frequency' => 'frequency_templates',
    'duration' => 'duration_templates',
    'instruction' => 'instruction_templates',
    'diagnosis' => 'diagnosis_templates',
    'chief_complaint' => 'chief_complaint_templates',
    'medical_history' => 'medical_history_templates',
    'examination_findings' => 'examination_findings_templates',
    'advice' => 'advice_templates',
    'investigation' => 'investigation_templates'
];

$templates = [];
foreach ($template_types as $type => $table) {
    $templates[$type] = [];
    $sql = "SELECT * FROM $table WHERE doctor_id = ? OR is_default = 1 ORDER BY is_default DESC, name";
    if ($stmt = mysqli_prepare($conn, $sql)) {
        mysqli_stmt_bind_param($stmt, "i", $doctor_id);
        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);
        while ($row = mysqli_fetch_assoc($result)) {
            $templates[$type][] = $row;
        }
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $is_template ? 'Create Template' : 'Create Prescription'; ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: 'Poppins', sans-serif; }
        .main-card { border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-card { border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .form-label { font-weight: 600; color: #4361ee; }
        .btn-primary { background: #4361ee; border: none; }
        .btn-success { background: #28a745; border: none; }
        .suggestion-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            display: none;
        }
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f5;
        }
        .suggestion-item:hover { background: #f0f0f0; }
        .drug-row { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        @media (max-width: 768px) {
            .drug-row { padding: 10px; }
            .btn { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <?php include 'navbar.php'; ?>

    <div class="container py-5">
        <div class="main-card bg-white">
            <div class="card-header bg-primary text-white rounded-top">
                <h3 class="mb-0"><?php echo $is_template ? 'Create New Template' : 'Create Prescription'; ?></h3>
            </div>
            <div class="card-body p-4 p-md-5">
                <form method="POST" id="prescriptionForm">
                    <!-- Patient Selection -->
                    <div class="section-card p-4">
                        <div class="row align-items-end">
                            <div class="col-lg-8">
                                <label class="form-label">Select Patient</label>
                                <select name="patient_id" class="form-select form-select-lg select2" <?php echo $is_template ? 'disabled' : 'required'; ?>>
                                    <option value="">Search patient by name or UID...</option>
                                    <?php
                                    $sql = "SELECT id, name, patient_uid, age, sex FROM patients WHERE doctor_id = ? ORDER BY name";
                                    if ($stmt = mysqli_prepare($conn, $sql)) {
                                        mysqli_stmt_bind_param($stmt, "i", $doctor_id);
                                        mysqli_stmt_execute($stmt);
                                        $result = mysqli_stmt_get_result($stmt);
                                        while ($p = mysqli_fetch_assoc($result)) {
                                            $selected = '';
                                            echo "<option value='{$p['id']}' $selected>{$p['name']} ({$p['patient_uid']}) - {$p['age']}y/{$p['sex']}</option>";
                                        }
                                    }
                                    ?>
                                </select>
                            </div>
                            <div class="col-lg-4 d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary flex-fill" data-bs-toggle="modal" data-bs-target="#addPatientModal">
                                    <i class='bx bx-user-plus'></i> Quick Add
                                </button>
                                <button type="button" class="btn btn-outline-secondary flex-fill" data-bs-toggle="modal" data-bs-target="#scanPatientModal">
                                    <i class='bx bx-qr-scan'></i> Scan QR
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Vitals -->
                    <div class="section-card p-4">
                        <h5 class="mb-3 text-primary">Vitals</h5>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">BP (mmHg)</label>
                                <input type="text" name="bp" class="form-control" value="<?php echo htmlspecialchars($form_data['bp']); ?>">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Pulse (bpm)</label>
                                <input type="text" name="pulse" class="form-control" value="<?php echo htmlspecialchars($form_data['pulse']); ?>">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Temperature (°F)</label>
                                <input type="text" name="temperature" class="form-control" value="<?php echo htmlspecialchars($form_data['temperature']); ?>">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">SpO2 (%)</label>
                                <input type="text" name="spo2" class="form-control" value="<?php echo htmlspecialchars($form_data['spo2']); ?>">
                            </div>
                        </div>
                    </div>

                    <!-- Clinical Fields with Auto-Suggestion -->
                    <div class="section-card p-4">
                        <h5 class="mb-3 text-primary">Clinical Information</h5>
                        <div class="row g-3">
                            <div class="col-lg-6 position-relative">
                                <label class="form-label">Chief Complaints</label>
                                <textarea name="chief_complaints" id="chief_complaints" class="form-control" rows="3"><?php echo htmlspecialchars($form_data['chief_complaints']); ?></textarea>
                                <div id="suggestions-chief_complaints" class="suggestion-box"></div>
                            </div>
                            <div class="col-lg-6 position-relative">
                                <label class="form-label">Medical History</label>
                                <textarea name="medical_history" id="medical_history" class="form-control" rows="3"><?php echo htmlspecialchars($form_data['medical_history']); ?></textarea>
                                <div id="suggestions-medical_history" class="suggestion-box"></div>
                            </div>
                            <div class="col-lg-6 position-relative">
                                <label class="form-label">Examination Findings</label>
                                <textarea name="examination_findings" id="examination_findings" class="form-control" rows="3"><?php echo htmlspecialchars($form_data['examination_findings']); ?></textarea>
                                <div id="suggestions-examination_findings" class="suggestion-box"></div>
                            </div>
                            <div class="col-lg-6 position-relative">
                                <label class="form-label">Diagnosis</label>
                                <textarea name="diagnosis" id="diagnosis" class="form-control" rows="3"><?php echo htmlspecialchars($form_data['diagnosis']); ?></textarea>
                                <div id="suggestions-diagnosis" class="suggestion-box"></div>
                            </div>
                            <div class="col-lg-6 position-relative">
                                <label class="form-label">Investigation</label>
                                <textarea name="investigation" id="investigation" class="form-control" rows="3"><?php echo htmlspecialchars($form_data['investigation']); ?></textarea>
                                <div id="suggestions-investigation" class="suggestion-box"></div>
                            </div>
                            <div class="col-lg-6 position-relative">
                                <label class="form-label">Advice</label>
                                <textarea name="advice" id="advice" class="form-control" rows="3"><?php echo htmlspecialchars($form_data['advice']); ?></textarea>
                                <div id="suggestions-advice" class="suggestion-box"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Drugs Section -->
                    <div class="section-card p-4">
                        <h5 class="mb-3 text-primary">Medicines</h5>
                        <div id="drugsList">
                            <!-- Loaded from template or empty -->
                            <?php foreach ($form_data['drugs'] as $index => $drug): ?>
                                <div class="drug-row">
                                    <!-- Drug row code -->
                                </div>
                            <?php endforeach; ?>
                        </div>
                        <button type="button" class="btn btn-outline-primary mt-3" id="addDrugRow">
                            <i class='bx bx-plus-medical'></i> Add Medicine
                        </button>
                    </div>

                    <!-- Next Visit & Save as Template -->
                    <div class="section-card p-4">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Next Visit Date</label>
                                <input type="date" name="next_visit" class="form-control" value="<?php echo $form_data['next_visit']; ?>">
                            </div>
                            <?php if (!$is_template): ?>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="save_as_template" id="saveAsTemplate">
                                        <label class="form-check-label" for="saveAsTemplate">
                                            Save as Template
                                        </label>
                                    </div>
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-secondary me-2" onclick="window.history.back()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class='bx bx-save me-2'></i> <?php echo $is_template ? 'Save Template' : 'Save Prescription'; ?>
                        </button>
                        <button type="button" class="btn btn-success btn-lg px-5 ms-2" onclick="printPreview()">
                            <i class='bx bx-printer me-2'></i> Print Preview
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals (Quick Add Patient, QR Scan, Treatment Template Load) -->

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $('.select2').select2();

        // Auto-Suggestion (working version)
        function setupAutosuggest(fieldId, suggestionDivId) {
            const textarea = document.getElementById(fieldId);
            const suggestionsDiv = document.getElementById(suggestionDivId);

            textarea.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length < 2) {
                    suggestionsDiv.innerHTML = '';
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                fetch(`ajax_suggestions.php?field=${fieldId}&q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsDiv.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(text => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = text;
                                div.onclick = () => {
                                    textarea.value = text;
                                    suggestionsDiv.style.display = 'none';
                                };
                                suggestionsDiv.appendChild(div);
                            });
                            suggestionsDiv.style.display = 'block';
                        } else {
                            suggestionsDiv.style.display = 'none';
                        }
                    });
            });

            document.addEventListener('click', function(e) {
                if (!textarea.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        setupAutosuggest('chief_complaints', 'suggestions-chief_complaints');
        setupAutosuggest('medical_history', 'suggestions-medical_history');
        setupAutosuggest('examination_findings', 'suggestions-examination_findings');
        setupAutosuggest('diagnosis', 'suggestions-diagnosis');
        setupAutosuggest('investigation', 'suggestions-investigation');
        setupAutosuggest('advice', 'suggestions-advice');

        // Add Drug Row, Load Template, QR Scan, Quick Add Patient, Print Preview — তোমার আগের কোড থেকে কপি করো
    </script>
</body>
</html>
